<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <title>éª‚äººå®å…¸/ç¥–å®‰è¯­å½•</title>
  <link rel="stylesheet" href="./css/material.deep_purple-pink.min.css">
  <link rel="stylesheet" href="./css/styles.css">
  <script src="./js/jquery.min.js"></script>
  <script src="./js/clipboard.min.js"></script>
  <link rel="icon" sizes="192x192" href="images/smile.png">
  <link rel="shortcut icon" href="images/smile.png">
</head>

<body class="mdl-demo mdl-color--grey-100 mdl-color-text--grey-700 mdl-base">
<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
  <header class="mdl-layout__header mdl-layout__header--scroll mdl-color--primary">
    <div class="mdl-layout--large-screen-only mdl-layout__header-row" style="margin:30px">
      <h3>éª‚äººå®å…¸</h3>
    </div>
    <div class="mdl-layout__tab-bar mdl-color--primary-dark">
      <a href="#index" class="mdl-layout__tab is-active">é¦–é¡µ</a>
    </div>
  </header>

  <main class="mdl-layout__content">
    <div class="mdl-layout__tab-panel is-active" id="index">

      <section class="section--center mdl-grid mdl-grid--no-spacing mdl-shadow--2dp">
        <div class="mdl-card mdl-cell mdl-cell--12-col" style="min-height:200px;height:auto">
          <div class="mdl-card__supporting-text mdl-grid mdl-grid--no-spacing"
               style="align-items: center; margin-top: 0px; min-height:200px">
            <div class="mdl-cell--12-col" style="text-align: center; padding: 20px;">
              <h4 id="txt_nmsl" style="margin: 0; line-height: 1.6;">å‡†å¤‡å°±ç»ªï¼Œè¯·å¼€ç«</h4>
            </div>
          </div>
        </div>
      </section>

      <section class="section--center mdl-grid mdl-grid--no-spacing">
        <div class="section__text mdl-cell mdl-cell--12-col" align='center' style="padding-top: 20px;">

          <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent"
                  onclick="random()" id="btn_random_max" style="margin: 0 10px;">
            <span id="span_random_max">ğŸ˜¤ ç«åŠ›å…¨å¼€</span>
          </button>

          <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent"
                  style='background-color:#46c792; margin: 0 10px;' data-clipboard-text="" id="btn_nmsl">
            <span id="span_copy">ğŸ“„ å¤åˆ¶å†…å®¹</span>
          </button>

        </div>
      </section>

      <div style="text-align: center;padding-top:30px; color: #999;">âš ï¸ ä»…ä¾›å¨±ä¹ï¼Œè¯·å‹¿ç”¨äºäººèº«æ”»å‡»ã€‚</div>
    </div>
  </main>
</div>

<script>
  var all_sentences = [];
  var recent_indexes = [];
  var buffer_size = 50;

  $(document).ready(function() {
    // 1. è¯»å– database.json
    $.getJSON("./database.json", function(data) {
      all_sentences = data;
      console.log("æ•°æ®åŠ è½½å®Œæˆï¼Œå®é™…è½½å…¥: " + data.length + " æ¡");

      if (data.length < buffer_size * 2) {
        buffer_size = Math.floor(data.length / 2);
      }

    }).fail(function() {
      $("#txt_nmsl").text("é”™è¯¯ï¼šæ— æ³•è¯»å– database.json");
    });

    var clipboard = new ClipboardJS('#btn_nmsl');
    clipboard.on('success', function(e) {
      var btnSpan = $("#span_copy");
      var originalText = btnSpan.text();
      btnSpan.text("âœ… å·²å¤åˆ¶!");
      $("#btn_nmsl").css("background-color", "#388E3C");
      setTimeout(function() {
        btnSpan.text(originalText);
        $("#btn_nmsl").css("background-color", "#46c792");
      }, 1500);
    });
  });

  function random() {
    if (all_sentences.length === 0) {
      $("#txt_nmsl").text("æ•°æ®åŠ è½½ä¸­...");
      return;
    }

    var index = -1;
    var max_retries = 10;
    var retries = 0;

    do {
      index = Math.floor(Math.random() * all_sentences.length);
      retries++;
    } while (recent_indexes.includes(index) && retries < max_retries);

    recent_indexes.push(index);
    if (recent_indexes.length > buffer_size) {
      recent_indexes.shift();
    }

    var text = all_sentences[index];

    $("#txt_nmsl").text(text);
    $("#btn_nmsl").attr("data-clipboard-text", text);
  }
</script>
</body>
</html>

